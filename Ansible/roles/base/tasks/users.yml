---

- name: "Block - clincha"
  block:
    - name: "clincha (group)"
      group:
        name: clincha
        state: present

    - name: "clincha"
      user:
        name: clincha
        group: clincha
        shell: /bin/bash
        expires: -1
        update_password: always
        password: "{{ lookup('env', 'CLINCHA_PASSWORD') | password_hash('sha512') }}"

    - name: "clincha (keys)"
      authorized_key:
        user: clincha
        state: present
        key: https://github.com/clincha.keys

    - name: "clincha (sudoers)"
      copy:
        src: clincha-sudoers
        dest: /etc/sudoers.d/clincha
        validate: 'visudo -cf %s'
        mode: 0440

- name: "Block - ansible"
  block:
    - name: "ansible"
      user:
        name: ansible
        update_password: always
        expires: -1
        password: "{{ lookup('env', 'ANSIBLE_PASSWORD') | password_hash('sha512') }}"

    - name: "ansible (sudoers)"
      copy:
        src: ansible-sudoers
        dest: /etc/sudoers.d/ansible
        validate: 'visudo -cf %s'
        mode: 0440

- name: "root"
  user:
    name: root
    update_password: always
    shell: /sbin/nologin
    password: "{{ lookup('env', 'ROOT_PASSWORD') | password_hash('sha512') }}"